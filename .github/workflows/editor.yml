name: git-bob acting

on:
  pull_request:
    types: [opened, synchronize]
  pull_request_review_comment:
    types: [ created ]

jobs:
  respond:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Print pull request number
      run: |  
        echo "Pull Request Number - ${{ github.event.pull_request.number }}"
        echo "Organization - ${{ github.repository_owner }}"
        echo "Repository Name - ${{ github.repository }}"

    - name: Print Job details
      run: |  
        echo "Run ID - ${{ github.run_id }}"
        echo "Run No - ${{ github.run_number }}"
        echo "Job    - ${{ github.job }}"
        echo "Job ID - ${{ github.job_id }}"

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.x

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install git-bob
        

    - name: Run git-bob
      env:
        GIT_BOB_AGENT_NAME: "editor"
        GIT_BOB_LLM_NAME: "${{ secrets.GIT_BOB_LLM_NAME }}"
        ANTHROPIC_API_KEY: "${{ secrets.ANTHROPIC_API_KEY }}"
        GOOGLE_API_KEY: "${{ secrets.GOOGLE_API_KEY }}"
        OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
        GH_MODELS_API_KEY: "${{ secrets.GH_MODELS_API_KEY }}"
        GITHUB_API_KEY: "${{ secrets.GITHUB_TOKEN }}"
        GITHUB_RUN_ID: "${{ github.run_id }}"
        TWINE_USERNAME: "${{ secrets.TWINE_USERNAME }}"
        TWINE_PASSWORD: "${{ secrets.TWINE_PASSWORD }}"
        SYSTEM_MESSAGE: |
          You are the editor of a scientific blog and you take your job very serious. 
          You use a discussion on a github pull-request for communicating with the author and the reviewers.
          When you receive a pull-request for reviewing, you confirm receiving it kindly, but you do not comment on the content on very detail.
          Instead, you ask reviewer1 to review the document (if you haven't asked them before). You do this with the phrase "reviewer1 review this please." (exactly like this).
          If the discussion already contains a comment from "reviewer1", you go ahead and also ask "reviewer2" for their feedback, analogously to reviewer1.
          If the discussion already contains a comment from "reviewer2", you have two options:
          * If both reviewers suggest the same (acceptance or rejection of the text modification), you summarize the reviews and the conclusion.
          * Otherwise, you ask reviewer3 for their feedback, analogously to how how you asked reviewer1 and 2.
          If the discussion contains a comment from all three reviewers, you summarize the reviews and the conclusion.
          When concluding, make sure you tag the original author of the pull-request so that they receive a notification.
      run: |
        git-bob github-action ${{ github.repository }} ${{ github.event.pull_request.number }} ${{ github.event.issue.number }}
